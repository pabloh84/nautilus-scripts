#!/bin/bash

__DEBUG_LOG_FILE="$(basename "${BASH_SOURCE[0]}").log"
# shellcheck source=scripts/_debug_output
# source ~/scripts/_debug_output

# Source the script '.common-functions.sh'.
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
ROOT_DIR=$(grep --only-matching "^.*scripts[^/]*" <<< "$SCRIPT_DIR")
source "$ROOT_DIR/.common-functions.sh"

# Initial checks
_check_dependencies zenity || exit 1

function create_m3u_file {
    __INPUT_FOLDER="$1"
    __OUTPUT_PLAYLIST="$2"
    echo $__INPUT_FOLDER
    echo $__OUTPUT_PLAYLIST

    if [ ! -d "$__INPUT_FOLDER" ]; then
        _log_error "Input folder not found."
        _msg_error "Input folder not found."
        return 1
    fi

    mapfile -t __AUDIO_FILES < <(find "$__INPUT_FOLDER" -maxdepth 1 -type f -iname "*.mp3" -o -iname "*.ogg" -o -iname "*.mkv" -o -iname "*.flac" -o -iname "*.wav" -o -iname "*.aac")
    # __AUDIO_FILES=$(find "$__INPUT_FOLDER" -type f -iname "*.mp3" -o -iname "*.ogg" -o -iname "*.flac" -o -iname "*.wav" -o -iname "*.aac")
    # if [ -z "$__AUDIO_FILES" ]; then
    if [[ ${#__AUDIO_FILES[@]} -eq 0 ]]; then
        _log_error "No audio files found in the input folder."
        _msg_error "No audio files found in the input folder."
        return 1
    fi

    echo $__AUDIO_FILES

    echo "#EXTM3U" > "$__OUTPUT_PLAYLIST"
    # for __FILE in "$__AUDIO_FILES"; do
    for __FILE in "${__AUDIO_FILES[@]}"; do
        # Use basename to get the __FILE name without the path
        echo "#EXTINF:-1,$(basename "$__FILE")" >> "$__OUTPUT_PLAYLIST"
        echo "$(basename "$__FILE")" >> "$__OUTPUT_PLAYLIST"
    done

    echo "Playlist created successfully: $__OUTPUT_PLAYLIST"
}

_main()
{
    local input_files=""
    local output_dir=""

    input_files=$(_get_files "par_type=directory; par_validate_conflict=true; par_max_items=1")
    output_dir="$input_files"

    export -f create_m3u_file

    # Execute the function '_main_task' for each file in parallel.
    _run_task_parallel "$input_files" "$output_dir"
    _display_result_box "$output_dir"
}

_main_task() {
    local input_file=$1
    local output_dir=$2
    local std_output
    local output_file

    echo "Main Task Treating $input_file"
    # output_file="$OUTPUT_DIR/$(_get_filename_without_extension "$input_file").zip"
    # output_file="$input_file"/"$input_file".m3u
    output_file=$(_get_output_filename "$input_file" "$output_dir" "par_extension_opt=replace; par_extension=m3u")

    # std_output=$(zip -9 -r "$output_file" "$input_file" 2>&1)
    std_output=$(create_m3u_file "$input_file" "$output_file")
    _check_output "$?" "$std_output" "$input_file" "$output_file" || return 1

}

_main "$@"
